<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Preflop Hand Rank Trainer</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b0f14; color:#e8eef7; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 12px; font-size: 24px; }
    .cardrow { display:flex; gap:16px; margin: 16px 0 8px; align-items:center; flex-wrap: wrap; }
    .playing-card{
      width: 110px; height: 150px; border-radius: 14px;
      background: #f8fbff; color:#111; box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:flex; flex-direction:column; justify-content:space-between; padding: 10px;
      border: 1px solid rgba(255,255,255,.14);
      user-select:none;
    }
    .corner { font-weight: 800; font-size: 22px; line-height: 1; }
    .suit { font-size: 26px; opacity:.9; }
    .center { display:flex; justify-content:center; align-items:center; font-size: 54px; font-weight: 900; }
    .red { color:#c81d25; }
    .black { color:#111; }
    .panel{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 16px;
      margin-top: 14px;
    }
    .row { display:flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    label { display:block; font-size: 12px; opacity:.85; margin: 0 0 6px; }
    input, button, select {
      border-radius: 12px; border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08); color:#e8eef7;
      padding: 10px 12px; font-size: 14px;
      outline: none;
    }
    input { width: 160px; }
    button { cursor:pointer; font-weight: 700; }
    button:hover { background: rgba(255,255,255,.12); }
    .muted { opacity:.75; }
    .pill{
      display:inline-flex; gap: 8px; align-items:center;
      padding: 8px 10px; border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      margin-right: 8px;
      margin-top: 8px;
      font-size: 13px;
    }
    .result { margin-top: 10px; line-height: 1.45; }
    .good { color: #6ee7b7; }
    .bad  { color: #fca5a5; }
    .tiny { font-size: 12px; opacity:.8; margin-top: 10px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; padding: 2px 6px; border-radius: 8px; background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.10); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Preflop Hand Rank Trainer</h1>
    <div class="muted">
      You get 2 cards. Guess the rank (1–169) or percentile (0–100). Then reveal the answer.
    </div>

    <div class="cardrow" id="cardRow"></div>

    <div class="panel">
      <div class="row">
        <div>
          <label for="mode">Mode</label>
          <select id="mode">
            <option value="rank" selected>Rank (1–169)</option>
            <option value="pct">Percentile (0–100, lower is better)</option>
          </select>
        </div>

        <div>
          <label id="guessLabel" for="guessRank">Your guess (1–169)</label>
          <input id="guessRank" inputmode="numeric" autocomplete="off" placeholder="e.g., 24" />
        </div>

        <button id="revealBtn">Reveal</button>
        <button id="nextBtn">Next hand</button>
        <button id="resetBtn">Reset score</button>
      </div>

      <div class="result" id="result"></div>

      <div>
        <span class="pill">Hand label: <b id="handLabel">...</b></span>
        <span class="pill">Score: <b id="score">0</b></span>
        <span class="pill">Streak: <b id="streak">0</b></span>
        <span class="pill">Best streak: <b id="bestStreak">0</b></span>
      </div>

      <div class="tiny">
        Tips: press <span class="kbd">Enter</span> to reveal, press <span class="kbd">N</span> for next.
      </div>
    </div>
  </div>

  <script type="module">
    import { RANKINGS, buildIndex } from "./preflop_rankings_169.js";

    // Build lookups + validate data (throws if anything is wrong)
    const { byCards: byHand } = buildIndex(RANKINGS);

    const RANK_VALUE = new Map([
      ["A",14],["K",13],["Q",12],["J",11],["T",10],
      ["9",9],["8",8],["7",7],["6",6],["5",5],["4",4],["3",3],["2",2]
    ]);

    const SUITS = [
      {c:"♠", color:"black", key:"s"},
      {c:"♥", color:"red",   key:"h"},
      {c:"♦", color:"red",   key:"d"},
      {c:"♣", color:"black", key:"c"},
    ];
    const RANKS = ["A","K","Q","J","T","9","8","7","6","5","4","3","2"];

    function makeDeck() {
      const deck = [];
      for (const r of RANKS) for (const s of SUITS) deck.push({rank:r, suit:s});
      return deck;
    }

    function randInt(n) { return Math.floor(Math.random() * n); }

    function drawTwo() {
      const deck = makeDeck();
      const a = deck.splice(randInt(deck.length), 1)[0];
      const b = deck.splice(randInt(deck.length), 1)[0];
      return [a,b];
    }

    // Convert two cards into 169-hand label like AKs / AKo / 77
    function toHandLabel(c1, c2) {
      const r1 = c1.rank, r2 = c2.rank;
      const v1 = RANK_VALUE.get(r1), v2 = RANK_VALUE.get(r2);

      if (r1 === r2) return r1 + r2; // pair

      // order high to low
      let hi = r1, lo = r2;
      if (v2 > v1) { hi = r2; lo = r1; }

      const suited = (c1.suit.key === c2.suit.key);
      return hi + lo + (suited ? "s" : "o");
    }

    function renderCard(card) {
      const isRed = card.suit.color === "red";
      const div = document.createElement("div");
      div.className = "playing-card";

      const top = document.createElement("div");
      top.className = "corner " + (isRed ? "red" : "black");
      top.innerHTML = `${card.rank}<div class="suit">${card.suit.c}</div>`;

      const mid = document.createElement("div");
      mid.className = "center " + (isRed ? "red" : "black");
      mid.textContent = card.suit.c;

      const bot = document.createElement("div");
      bot.className = "corner " + (isRed ? "red" : "black");
      bot.style.transform = "rotate(180deg)";
      bot.innerHTML = `${card.rank}<div class="suit">${card.suit.c}</div>`;

      div.appendChild(top);
      div.appendChild(mid);
      div.appendChild(bot);
      return div;
    }

    // State
    let current = null; // {cards:[c1,c2], label, data}
    let revealed = false;
    let score = 0;
    let streak = 0;
    let bestStreak = 0;

    // Elements
    const cardRow = document.getElementById("cardRow");
    const guessRank = document.getElementById("guessRank");
    const revealBtn = document.getElementById("revealBtn");
    const nextBtn = document.getElementById("nextBtn");
    const resetBtn = document.getElementById("resetBtn");
    const result = document.getElementById("result");
    const handLabelEl = document.getElementById("handLabel");
    const scoreEl = document.getElementById("score");
    const streakEl = document.getElementById("streak");
    const bestStreakEl = document.getElementById("bestStreak");
    const modeEl = document.getElementById("mode");
    const guessLabel = document.getElementById("guessLabel");

    function setStats() {
      scoreEl.textContent = String(score);
      streakEl.textContent = String(streak);
      bestStreakEl.textContent = String(bestStreak);
    }

    function syncModeUI() {
      const mode = modeEl.value;
      if (mode === "rank") {
        guessLabel.textContent = "Your guess (1–169)";
        guessRank.placeholder = "e.g., 24";
        guessRank.inputMode = "numeric";
      } else {
        guessLabel.textContent = "Your guess (0–100, lower is better)";
        guessRank.placeholder = "e.g., 62";
        guessRank.inputMode = "numeric";
      }
    }

    function newHand() {
      revealed = false;
      result.innerHTML = "";
      guessRank.value = "";
      guessRank.focus();

      const cards = drawTwo();
      const label = toHandLabel(cards[0], cards[1]);
      const data = byHand.get(label) || null;

      current = { cards, label, data };

      cardRow.innerHTML = "";
      cardRow.appendChild(renderCard(cards[0]));
      cardRow.appendChild(renderCard(cards[1]));

      handLabelEl.textContent = label + (data ? "" : " (not found in list)");
    }

    function reveal() {
      if (!current || revealed) return;

      const raw = String(guessRank.value).trim();
      const mode = modeEl.value;

      const g = Number(raw);
      if (!Number.isFinite(g)) {
        result.innerHTML = `<span class="bad">Enter a number.</span>`;
        return;
      }

      if (!current.data) {
        result.innerHTML = `<div class="bad">This hand label (${current.label}) was not found in the rankings map.</div>`;
        streak = 0;
        setStats();
        revealed = true;
        return;
      }

      const actualRank = Number(current.data.Rank);
      const actualPct = Number(current.data.Percentile);
      const actual = (mode === "rank") ? actualRank : actualPct;

      // Validate guess range
      if (mode === "rank") {
        if (g < 1 || g > 169) {
          result.innerHTML = `<span class="bad">Enter a number from 1 to 169.</span>`;
          return;
        }
      } else {
        if (g < 0 || g > 100) {
          result.innerHTML = `<span class="bad">Enter a number from 0 to 100.</span>`;
          return;
        }
      }

      revealed = true;

      const diff = Math.abs(actual - g);

      // Scoring rule:
      // - Rank mode: exact match
      // - Percentile mode: within 2 points counts as correct
      const correct = (mode === "rank") ? (actual === g) : (diff <= 2);

      if (correct) {
        score += 1;
        streak += 1;
        if (streak > bestStreak) bestStreak = streak;
      } else {
        streak = 0;
      }
      setStats();

      const cls = correct ? "good" : "bad";
 const headerLabel = (mode === "rank") ? "Actual rank" : "Actual percentile";

// Extra feedback for percentile mode (lower = better)
let directionLine = "";
if (mode === "pct") {
  const signed = actual - g; // positive means actual is worse (higher) than guessed
  if (signed === 0) {
    directionLine = "Exactly right.";
  } else if (signed > 0) {
    directionLine = `The hand was <b>${signed}</b> points <b>worse</b> than you predicted.`;
  } else {
    directionLine = `The hand was <b>${Math.abs(signed)}</b> points <b>better</b> than you predicted.`;
  }
}

result.innerHTML = `
  <div class="${cls}">
    ${headerLabel}: <b>${actual}</b> (you guessed <b>${g}</b>${mode === "rank" ? `, off by <b>${diff}</b>` : ""})
    ${mode === "pct" ? `<div class="muted">${directionLine}</div>` : ""}
  </div>
  <div class="muted">
    Rank: <b>#${actualRank}</b> |
    Percentile: <b>${actualPct}</b> |
    Sklansky group: <b>${current.data["Sklansky Group"]}</b> |
    Win: <b>${current.data["% win"]}</b> |
    Tie: <b>${current.data["% tie"]}</b>
  </div>
`;
    }

    function resetScore() {
      score = 0; streak = 0; bestStreak = 0;
      setStats();
      result.innerHTML = "";
      guessRank.value = "";
      guessRank.focus();
    }

    // Events
    revealBtn.addEventListener("click", reveal);
    nextBtn.addEventListener("click", newHand);
    resetBtn.addEventListener("click", resetScore);

    modeEl.addEventListener("change", () => {
      syncModeUI();
      guessRank.value = "";
      guessRank.focus();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter") reveal();
      if (e.key.toLowerCase() === "n") newHand();
    });

    // Init
    syncModeUI();
    setStats();
    newHand();
  </script>
</body>
</html>
